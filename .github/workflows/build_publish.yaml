name: Render and Publish
on:
  push:
    branches:
      - master

jobs:
  build-deploy:
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
        - name: Check out repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        - name: Install Nix
          uses: DeterminateSystems/nix-installer-action@main

        - name: Setup rstats-on-nix cache
          uses: cachix/cachix-action@v15
          with:
            name: rstats-on-nix

        - name: Build Nix environment
          run: nix-build

        - name: Render posts with specific Nix dependencies (only if changed)
          run: |
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            
            for nix_file in posts/*.nix; do
              if [[ -f "$nix_file" && "$nix_file" != "posts/default.nix" ]]; then
                post_name=$(basename "${nix_file%.nix}")
                qmd_file="posts/${post_name}.qmd"
                
                if echo "$CHANGED_FILES" | grep -q "^${qmd_file}$" || [[ ! -d "_freeze/posts/${post_name}" ]]; then
                  echo "Rendering $post_name with specific dependencies..."
                  ./render-post.sh "$post_name"
                else
                  echo "Skipping $post_name (unchanged)"
                fi
              fi
            done

        - name: Render site
          run: nix-shell --run "quarto render"

        - name: Commit updated freeze folder
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            if [[ -n $(git status _freeze --porcelain) ]]; then
              git add _freeze
              git commit -m "Update freeze folder [skip ci]"
              git push
            else
              echo "No freeze changes to commit"
            fi

        - name: Publish to GitHub Pages
          uses: rstats-on-nix/quarto-nix-actions/publish@main
          with:
            render: false
            target: gh-pages
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
