name: Render and Publish
on:
  push:
    branches:
      - master

jobs:
  build-deploy:
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
        - name: Check out repository
          uses: actions/checkout@v4

        - name: Install Nix
          uses: DeterminateSystems/nix-installer-action@main

        - name: Setup rstats-on-nix cache
          uses: cachix/cachix-action@v15
          with:
            name: rstats-on-nix

        - name: Build Nix environment
          run: nix-build

        - name: Render posts with specific Nix dependencies
          run: |
            # Render each post that has a specific .nix file
            # Quarto's freeze:auto will skip if source unchanged
            for nix_file in posts/*.nix; do
              if [[ -f "$nix_file" && "$nix_file" != "posts/default.nix" ]]; then
                post_name=$(basename "${nix_file%.nix}")
                echo "Rendering $post_name with specific dependencies..."
                ./render-post.sh "$post_name"
              fi
            done

        - name: Render remaining posts with base environment
          run: |
            # Render posts without specific .nix files
            # Quarto's freeze:auto will skip if source unchanged
            nix-shell --run '
              for qmd_file in posts/*.qmd posts/*.Qmd; do
                [[ -f "$qmd_file" ]] || continue
                base=$(basename "${qmd_file%.*}")
                if [[ ! -f "posts/${base}.nix" ]]; then
                  echo "Rendering $qmd_file with base environment..."
                  quarto render "$qmd_file"
                fi
              done
            '

        - name: Build site
          run: nix-shell --run "quarto render"

        - name: Publish to GitHub Pages
          uses: rstats-on-nix/quarto-nix-actions/publish@main
          with:
            render: false
            target: gh-pages
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
