name: Render and Publish
on:
  push:
    branches:
      - master

jobs:
  build-deploy:
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
        - name: Check out repository
          uses: actions/checkout@v4

        - name: Install Nix
          uses: DeterminateSystems/nix-installer-action@main

        - name: Setup rstats-on-nix cache
          uses: cachix/cachix-action@v15
          with:
            name: rstats-on-nix

        - name: Render posts with specific Nix dependencies
          run: |
            for nix_file in posts/*.nix; do
              if [[ -f "$nix_file" && "$nix_file" != "posts/default.nix" ]]; then
                post_name=$(basename "${nix_file%.nix}")
                echo "Rendering $post_name with specific dependencies..."
                ./render-post.sh "$post_name"
              fi
            done

        - name: Publish to GitHub Pages (and render)
          uses: rstats-on-nix/quarto-nix-actions/publish@main
          with:
            render: true
            target: gh-pages
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

